# 多 Agent 协作：接口同步策略

本文档说明在多个 Agent 协同开发 TenEngine 时，如何**定义、引用和同步**跨模块接口，避免接口不一致导致的集成失败。

---

## 1. 原则

- **单一事实来源**：跨模块的“谁提供什么、谁消费什么”写在 `specs/_contracts/` 的契约文件中；各模块的 spec 引用契约而非重复描述接口细节。
- **契约先行**：下游模块（消费者）依赖的接口，由上游模块（提供方）的契约定义；Agent 在实现或改 spec 前先读契约。
- **变更即同步**：任何 Agent 修改某模块的**对外接口**时，必须更新对应契约文件，并检查依赖该契约的模块列表，必要时更新其 spec 或创建 follow-up 任务。

---

## 2. 目录与角色

| 位置 | 用途 |
|------|------|
| `specs/_contracts/` | 存放**跨模块接口契约**：API 边界、数据类型、调用顺序、版本。 |
| `specs/_contracts/000-module-dependency-map.md` | 模块依赖图：谁依赖谁、共享边界一览。 |
| `specs/XXX/spec.md` | 各特性规格；必须声明「本模块遵守/提供的契约」及「依赖的契约」。 |
| `.specify/memory/constitution.md` | 全局原则（如 ABI 版本、模块边界）；契约不得违反宪法。 |

每个 Agent 的工作范围通常对应一个或多个 `specs/00X-xxx/` 下的特性；跨该特性边界的接口以契约为准。

---

## 3. 工作流

### 3.1 开发/实现前

1. 打开本特性对应的 `spec.md`，查看 **Dependencies** 与 **接口契约** 小节。
2. 阅读 `specs/_contracts/000-module-dependency-map.md`，确认本模块的上游（依赖谁）和下游（被谁依赖）。
3. 对每一个**上游依赖**，阅读其契约文件（如 `specs/_contracts/core-public-api.md`），在实现时只使用契约中已声明的类型与接口，不依赖“未写入契约”的行为。

### 3.2 修改本模块对外接口时

1. 更新本模块对应的契约文件（见 `_contracts/` 下以模块或边界命名的文件）。
2. 在契约中注明**版本或变更说明**（与 Constitution 的版本/ABI 要求一致）。
3. 在 `000-module-dependency-map.md` 中查看**依赖本模块**的下游列表；若接口有破坏性变更，则：
   - 在对应下游的 spec 或 checklist 中留下“需随 XXX 契约变更做适配”的待办，或
   - 创建明确的 follow-up 任务/issue 供负责下游模块的 Agent 处理。

### 3.3 评审/合并前

1. 检查：本 PR 是否改动某模块的**公开 API 或跨模块数据结构**？
2. 若有，确认 `specs/_contracts/` 下对应契约已更新，且依赖图与下游说明已更新或已创建跟进任务。

---

## 4. 契约文件怎么写

- **文件名**：以模块或边界命名，如 `core-public-api.md`、`rci-public-api.md`、`pipeline-to-rci.md`。
- **建议结构**（可随需要增删）：
  - **适用模块**：本契约由哪一 spec（如 001-engine-core-module）实现并负责。
  - **消费者**：哪些模块/特性依赖本契约（与依赖图一致）。
  - **版本/ABI**：当前契约对应的版本或 ABI 承诺。
  - **类型与句柄**：跨边界使用的关键类型、句柄、枚举（名称、语义、生命周期）。
  - **接口/能力列表**：提供方保证提供的能力（如“分配/释放内存”“提交命令缓冲”）；可写伪代码或简短描述。
  - **调用顺序与约束**：如“必须先初始化再创建资源”“命令缓冲在帧末提交”。
  - **变更记录**：重要变更的日期与简要说明，便于下游同步。

契约以**稳定、可被多 Agent 引用**为目标，避免实现细节；实现细节留在各模块的 spec 或代码中。

---

## 5. 在 spec 中引用契约

在各特性的 `spec.md` 中建议包含：

- **本模块提供/实现的契约**：例如“本模块实现契约 `specs/_contracts/core-public-api.md`”。
- **本模块依赖的契约**：在 **Dependencies** 中列出，例如“依赖 `specs/_contracts/core-public-api.md`（平台抽象、内存）、`specs/_contracts/rci-public-api.md`（命令缓冲提交）”。

这样，任何 Agent 打开该 spec 时都能直接跳转到契约文件，保证实现与接口定义一致。

---

## 6. 小结

- 接口的**单一事实来源**在 `specs/_contracts/`。
- 每个 Agent：**读**自己依赖的契约，**写/改**自己负责的契约，**改接口时**更新契约并通知下游。
- 依赖图 `000-module-dependency-map.md` 用于快速查“谁依赖谁”和“改了这个会影响谁”，减少多 Agent 并行时的接口不同步问题。
