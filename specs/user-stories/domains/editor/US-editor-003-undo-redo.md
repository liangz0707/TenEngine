# US-editor-003：撤销与重做（Undo/Redo、命令栈、与 Object 序列化联动）

- **标题**：在编辑器内对场景、实体、属性等的修改可**撤销**（Undo）与**重做**（Redo）；修改以**命令**形式入栈，命令可**序列化**（与 002-Object 可选联动）；栈深度可配置，与 Editor 生命周期一致。
- **编号**：US-editor-003

---

## 1. 角色/触发

- **角色**：使用编辑器的开发者
- **触发**：在编辑器内修改场景节点、Entity、属性等后，希望**撤销**（Ctrl+Z）或**重做**（Ctrl+Y）；撤销/重做应恢复正确的对象状态，且与**属性面板**、**场景树**、**渲染窗口**一致。

---

## 2. 端到端流程

1. 用户在编辑器内执行**可撤销操作**（如移动节点、修改属性、删除 Entity）；Editor 将操作封装为**命令**（Command），执行后**入栈**（Undo 栈）；Redo 栈清空。
2. 用户触发 **Undo**：从 Undo 栈弹出最近命令、执行其 **undo()**（恢复旧状态）、该命令入 Redo 栈；场景树/属性面板/渲染窗口同步刷新。
3. 用户触发 **Redo**：从 Redo 栈弹出、执行 **redo()**、命令再入 Undo 栈。
4. **命令**可持有**序列化快照**（旧值/新值），与 002-Object 属性序列化联动；或命令仅记录「逆操作」句柄，由实现决定。栈深度可配置（如 50）；与 Editor 生命周期一致，切换场景或退出时清空或持久化（可选）。

---

## 3. 涉及模块

| 模块 | 职责摘要 |
|------|----------|
| 024-Editor | UndoStack、RedoStack、pushCommand、undo、redo、与属性面板/场景树/渲染窗口同步 |
| 002-Object | 可选：属性序列化、命令快照 |
| 004-Scene / 005-Entity | 命令执行时修改场景/Entity；撤销时恢复 |

---

## 4. 每模块职责与 I/O

### 024-Editor

- **职责**：提供 **IUndoSystem** 或等价：**pushCommand(command)**、**undo()**、**redo()**、**canUndo/canRedo**；命令接口（execute、undo、redo）；与属性面板、场景树、渲染窗口**同步刷新**；栈深度配置；与 002-Object 可选联动（命令序列化）。
- **输入**：用户操作封装为 Command；用户触发 Undo/Redo。
- **输出**：场景/Entity/属性恢复至对应状态；UI 同步。

---

## 5. 派生 ABI（与契约对齐）

- **024-editor-ABI**：IUndoSystem、pushCommand、undo、redo、ICommand。详见 `specs/_contracts/024-editor-ABI.md`。

---

## 6. 验收要点

- 编辑器内修改可撤销与重做；Undo/Redo 后场景树、属性面板、渲染窗口状态一致；栈深度可配置。
