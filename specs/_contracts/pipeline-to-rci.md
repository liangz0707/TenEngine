# 契约：渲染流水线 → RCI（命令缓冲与提交）

## 适用边界

- **产出方**：`specs/006-render-pipeline-system`（渲染系统流水线）
- **消费方**：`specs/002-rendering-rci-interface`（RCI 图形抽象层）

本契约描述从「场景/模型资源 → drawcall → 抽象命令缓冲」到「RCI 执行」的接口边界，确保两个模块由不同 Agent 实现时仍能正确对接。

## 数据流

```
场景/模型资源 → 场景收集 → drawcall 资源创建 → 抽象命令缓冲 → RCI 提交并执行
```

## 抽象命令缓冲（Pipeline 产出 / RCI 消费）

- **含义**：与具体图形 API 解耦的一帧渲染命令序列；RCI 负责将其转换为底层 API 调用。
- **内容**：至少包含与「绘制调用」对应的信息（如几何、材质/着色器引用、状态），以及可选的资源状态迁移、同步点等；具体结构由实现与 RCI 契约共同约定。
- **生命周期**：由流水线在每帧相应阶段创建/填充，提交给 RCI 后由 RCI 在本帧内消费；RCI 不假定命令缓冲在帧外有效。

## 资源创建时机

- 流水线可配置「何时创建 drawcall 相关资源、何时分配/写入命令缓冲」；RCI 仅约定：**接收到的命令缓冲在提交时已就绪**，且格式符合 `rci-public-api.md` 与本文约定。
- 资源状态机（未创建→就绪→使用中→可回收）由流水线管理；跨边界时资源须处于 RCI 可安全使用的状态。

## 提交约定

- 流水线在每帧的适当时机（如场景收集与 drawcall 构建完成后）将**本帧的抽象命令缓冲**交给 RCI。
- RCI 提供「提交命令缓冲」的接口（名称与签名以实现为准；本契约不规定具体语言级 API），保证：
  - 同一帧内命令按提交顺序或约定顺序执行；
  - 命令缓冲引用到的资源在执行时仍有效且状态正确。

## 错误与降级

- 若 RCI 暂时不可用或拒绝接收（如设备丢失），流水线应能安全降级或明确失败，并保持自身资源状态一致、可恢复（见 006 spec 的 FR-006）。
- 若命令缓冲格式或引用不合法，RCI 可返回错误；流水线不得依赖未定义行为。

## 变更记录

| 日期 | 变更说明 |
|------|----------|
| （初始） | 从 006-render-pipeline-system 与 002-rendering-rci-interface spec 提炼，定义 Pipeline↔RCI 边界 |
